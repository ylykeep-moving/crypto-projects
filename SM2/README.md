# README

## 一、实验目的

1. 理解SM2算法的数学原理及其在数字签名中的应用。
2. 使用Python编写SM2算法的完整实现，包括密钥生成、签名和验签。
3. 分析算法正确性，并验证签名有效性。
4. 探讨SM2在软件实现中的优化方向。

## 二、算法概述

SM2是基于椭圆曲线密码体制（ECC）的一种中国国家密码算法。其本质基于有限域上的椭圆曲线点运算，与ECDSA类似，但使用SM3作为哈希函数，并引入用户身份绑定值Z。

签名核心步骤如下：

- 对消息 $M$ 计算摘要 $e = \text{Hash}(Z \| M)$；
- 随机选择 $k \in [1, n-1]$，计算 $kG = (x_1, y_1)$；
- 计算 $r = (e + x_1) \mod n$；
- 若 $r = 0$ 或 $r + k = n$，重新选 $k$；
- 计算 $s = \left((1 + d_A)^{-1} \cdot (k - r d_A)\right) \mod n$；
- 签名为 $(r, s)$。

## 三、实验环境

- 编程语言：Python 3.10+
- 编辑器：Visual Studio Code / Typora
- 哈希函数：SHA256（模拟SM3）

## 四、实现过程

### 4.1 椭圆曲线参数（ecc.py）

选用SM2推荐曲线参数：

- 素域：
  
  $$
  p = 2^{256} - 2^{224} - 2^{96} + 2^{64} - 1
  $$

- 曲线方程：

  $$
  E: y^2 = x^3 + ax + b
  $$

- 参数：

  $$
  a = -3 \\
  b = \text{28E9...E93（hex值）} \\
  n = \text{基点阶，为256位素数} \\
  G = (x_G, y_G) \quad \text{基点坐标}
  $$

### 4.2 点运算实现

**点加法**：若 $P = (x_1, y_1), Q = (x_2, y_2)$，则：

- 当 $P \ne Q$：

  $$
  \lambda = \frac{y_2 - y_1}{x_2 - x_1} \mod p
  $$

- 当 $P = Q$：

  $$
  \lambda = \frac{3x_1^2 + a}{2y_1} \mod p
  $$

- 得到结果点 $R = (x_3, y_3)$：

  $$
  x_3 = \lambda^2 - x_1 - x_2 \mod p \\
  y_3 = \lambda(x_1 - x_3) - y_1 \mod p
  $$

**倍点运算**：采用双倍加法（double and add）实现 $kP$。

### 4.3 密钥生成

```python
priv = random.randint(1, n - 1)
pub = scalar_mult(priv, G)
```

### 4.4 签名算法

1. 计算 $e = \text{Hash}(M)$；
2. 随机生成 $k$；
3. 计算 $kG = (x_1, y_1)$；
4. 计算 $r = (e + x_1) \mod n$；
5. 计算 $s = ((1 + d)^{-1}(k - rd)) \mod n$；
6. 输出 $(r, s)$。

### 4.5 验签算法

1. 计算 $e = \text{Hash}(M)$；
2. 计算 $t = r + s \mod n$；
3. 计算 $sG + tP = (x_1, y_1)$；
4. 验证 $R = (e + x_1) \mod n$ 是否等于 $r$。

### 4.6 哈希函数说明

本实验中使用 `hashlib.sha256` 代替 SM3，如需使用国密标准哈希函数，可替换为 `gmssl.sm3`.

---

## 五、实验结果

![实验结果](D:\crypto-projects\SM2\实验结果.png)

```text
私钥: 0xd945e787ca636d9f6381a1d6e2b8a0251fece69587e2463d3a31fb8e8277871a
公钥: (71094065205464026612659582907951906414833588807281885293316723720014540153524, 86446907040048178655496908728090187360629778627935991560555460787814752631069)
签名 r: 0xea67dab1cef65a9341c4842c9082f8370de243ad0c81dd1fad7b6dcf05a098a4
签名 s: 0xb1048a6f343ff4a8c74b92bb1b5726f345d8cb47dbd27bf70a1a62ea702d2747
验证结果: True
```

- 签名验证成功，说明算法逻辑正确；
- 多次签名结果不同，表明随机数k工作正常；
- 公钥确实在椭圆曲线定义域上；
- 实现不依赖任何第三方密码库，便于教学使用。

---

## 六、结论

本实验从零实现SM2签名算法，完成密钥生成、签名与验签全过程，并进行了有效性验证。分析并提出了性能和安全优化策略，为后续嵌入式或工业级部署提供基础支持。

